rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * Core Philosophy: This ruleset implements a role-based security model with strict data ownership for clients.
     * There are three primary roles: Client, Staff, and Admin.
     * - Clients have exclusive control over their personal data and can view their own reservations and invoices.
     * - Staff members have broad access to manage operational data like rooms, reservations, and invoices.
     * - Admins have full privileges, including the ability to manage staff and role assignments.
     *
     * Data Structure: Data is organized into top-level collections for each major entity (clients, rooms, reservations, etc.).
     * Roles are managed through dedicated `/roles_admin/{uid}` and `/roles_staff/{uid}` collections, where the existence of a
     * document grants the corresponding role, enabling highly performant access checks.
     *
     * Key Security Decisions:
     * - Client data is strictly segregated; users can only access documents where their UID matches the document ID or a denormalized `clientId` field.
     * - Listing of sensitive collections (like `/clients`, `/reservations`, `/invoices`) is prohibited for non-staff members to prevent data leakage.
     * - All write operations on operational data require staff or admin privileges.
     * - Role management is restricted exclusively to Admins.
     *
     * Denormalization for Authorization: To ensure performant and secure rules, authorization-critical data is denormalized.
     * For instance, `reservations` documents contain a `clientId` field, allowing a client's access to be verified without
     * requiring extra database reads. This avoids slow and costly `get()` calls in most authorization checks.
     *
     * Structural Segregation: The use of distinct top-level collections for each data type provides a clean separation of concerns
     * and allows for clear, homogenous security rules to be applied to each collection.
     */

    // ------------------------------------------------------------------------
    // Helper Functions
    // ------------------------------------------------------------------------

    /**
     * Checks if the user is authenticated.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * Checks if the authenticated user's UID matches the provided userId.
     * Used to verify resource ownership.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * Checks if the user has an Admin role by verifying the existence
     * of their UID in the /roles_admin collection.
     */
    function isAdmin() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * Checks if the user has a Staff role by verifying the existence
     * of their UID in the /roles_staff collection.
     */
    function isStaff() {
      return isSignedIn() && exists(/databases/$(database)/documents/roles_staff/$(request.auth.uid));
    }

    /**
     * Checks if the user has either Staff or Admin privileges.
     * This is the primary check for access to operational data.
     */
    function isStaffOrAdmin() {
      return isStaff() || isAdmin();
    }

    // ------------------------------------------------------------------------
    // Collection Rules
    // ------------------------------------------------------------------------

    /**
     * @description Manages client profiles. Only the client themselves can create, view, or modify their own profile.
     * @path /clients/{clientId}
     * @allow (create) An authenticated user creating their own client profile: `request.auth.uid == clientId`.
     * @deny (get) A user trying to read another client's profile.
     * @deny (list) Any user, including staff, trying to list all clients to protect privacy.
     * @principle Restricts access to a user's own data tree and enforces relational integrity.
     */
    match /clients/{clientId} {
      allow get: if isOwner(clientId);
      allow list: if false;
      allow create: if isOwner(clientId) && request.resource.data.id == clientId;
      allow update: if isOwner(clientId) && resource != null && request.resource.data.id == resource.data.id;
      allow delete: if isOwner(clientId) && resource != null;
    }

    /**
     * @description Manages hotel room information. Only staff and admins can view and manage rooms.
     * @path /rooms/{roomId}
     * @allow (get, list, create) A staff member accessing room data.
     * @deny (get, list, create) A regular client trying to access room data.
     * @principle Enforces role-based access for internal operational data.
     */
    match /rooms/{roomId} {
      allow get, list: if isStaffOrAdmin();
      allow create: if isStaffOrAdmin();
      allow update, delete: if isStaffOrAdmin() && resource != null;
    }

    /**
     * @description Manages reservation details. Clients can create and read their own reservations. Staff and admins can manage all reservations.
     * @path /reservations/{reservationId}
     * @allow (create) A client creating a reservation for themselves (`request.resource.data.clientId == request.auth.uid`).
     * @allow (get) A client reading a reservation where `resource.data.clientId` matches their UID.
     * @allow (update) A staff member modifying any reservation.
     * @deny (list) A client attempting to list all reservations in the system.
     * @deny (update) A client attempting to modify their own reservation after creation.
     * @principle Combines ownership-based reads with role-based writes for shared resources.
     */
    match /reservations/{reservationId} {
      allow get: if isStaffOrAdmin() || (isSignedIn() && resource.data.clientId == request.auth.uid);
      allow list: if isStaffOrAdmin();
      allow create: if isStaffOrAdmin() || (isSignedIn() && request.resource.data.clientId == request.auth.uid);
      allow update, delete: if isStaffOrAdmin() && resource != null;
    }

    /**
     * @description Manages invoices. Clients can read their own invoices. Staff and admins can manage all invoices.
     * @path /invoices/{invoiceId}
     * @allow (get) A client reading their own invoice, verified by checking the linked reservation.
     * @allow (create, list) A staff member creating or listing invoices.
     * @deny (get) A client trying to read another user's invoice.
     * @deny (create) A client trying to create their own invoice.
     * @principle Uses a cross-document `get()` to securely authorize access based on a related document's ownership.
     */
    match /invoices/{invoiceId} {
      allow get: if isStaffOrAdmin() || (isSignedIn() && get(/databases/$(database)/documents/reservations/$(resource.data.reservationId)).data.clientId == request.auth.uid);
      allow list: if isStaffOrAdmin();
      allow create: if isStaffOrAdmin();
      allow update, delete: if isStaffOrAdmin() && resource != null;
    }

    /**
     * @description Manages staff member profiles. Only admins can create, update, or delete staff profiles. All staff can view profiles.
     * @path /staff/{staffId}
     * @allow (create, delete) An admin creating or deleting a staff profile.
     * @allow (get, list) Any staff member viewing the list of staff.
     * @deny (create, update) A non-admin staff member trying to modify a staff profile.
     * @principle Enforces strict, high-privilege (Admin) role-based access for managing sensitive user data.
     */
    match /staff/{staffId} {
      allow get, list: if isStaffOrAdmin();
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages admin role assignments. Only other admins can grant or revoke admin status.
     * @path /roles_admin/{uid}
     * @allow (create, delete) An admin adding or removing another user as an admin.
     * @deny (create, delete) Any user who is not an admin attempting to change roles.
     * @principle Secures the role management system by ensuring only the highest-level role can modify it.
     */
    match /roles_admin/{uid} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }

    /**
     * @description Manages staff role assignments. Only admins can grant or revoke staff status.
     * @path /roles_staff/{uid}
     * @allow (create, delete) An admin adding or removing a user's staff role.
     * @deny (create, delete) A staff member trying to add another staff member.
     * @principle Secures the role management system by ensuring only admins can modify staff roles.
     */
    match /roles_staff/{uid} {
      allow get, list: if isAdmin();
      allow create: if isAdmin();
      allow update, delete: if isAdmin() && resource != null;
    }
  }
}